<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <title>University Search</title>

</head>

<body>
    <header>
        <h1>United States of Universities</h1>
        <div class="search-container">
            <form id="searchForm">
                <input type="text" id="searchInput" placeholder="Search..." oninput="handleInput(event)">
                <button type="submit">Search</button>
            </form>
            <span class='operators'>
                <button onclick="addLogicalOperator('AND')">AND</button>
                <button onclick="addLogicalOperator('OR')">OR</button>
                <!-- <button onclick="addLogicalOperator('NOT')">NOT</button> -->
            </span>
        </div>
    </header>

    <main id="searchResults" class="results-container">
        <!-- Search results will be displayed here -->
    </main>

    <!-- <script src="search.js"></script> -->
    <script>
        function handleInput(event) {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.trim();
            // You can directly perform the search here passing the query to Elasticsearch
            searchElasticsearch(query)
        }

        function addLogicalOperator(operator) {
            const searchInput = document.getElementById('searchInput');
            const currentQuery = searchInput.value.trim();
            const selectionStart = searchInput.selectionStart;

            if (currentQuery.length > 0) {
                searchInput.value = `${currentQuery} ${operator} `;
            } else {
                searchInput.value = `${operator} `;
            }

            searchInput.setSelectionRange(selectionStart + operator.length + 1, selectionStart + operator.length + 1);

            // You can handle the operator here or include it in the search directly
            const currentOperator = operator;
        }

        document.getElementById('searchForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const searchTerm = document.getElementById('searchInput').value;
            searchElasticsearch(searchTerm);
        });

        
    function searchElasticsearch(query) {
        console.log('Query = ', query);
        const queryToUse = query.trim(); // Remove leading/trailing whitespaces

        if (queryToUse === '') {
            displaySearchResults([]); // Display no results if query is empty
            return; // Exit function early if query is empty
        }

        // Split the query by spaces to handle logical operators
        const terms = queryToUse.split(/\s+/);
        console.log(terms);
        const shouldClauses = [];
        let currentOperator = 'OR'; // Default operator is OR

        terms.forEach(term => {
            if (term.toUpperCase() === 'AND') {
                console.log('AND operator');
                currentOperator = 'AND'; // Set the operator to AND if encountered
            } else if (term.toUpperCase() === 'OR') {
                console.log('OR operator');
                currentOperator = 'OR'; // Set the operator to OR if encountered
            } else {
                // For other terms, construct wildcard queries for multiple fields
                const wildcardQuery = {
                    bool: {
                        should: [
                            { wildcard: { Name: `${term}*` } },
                            { wildcard: { Description: `${term}*` } },
                            { wildcard: { Website: `${term}*` } }
                        ]
                    }
                };

                // Use 'must' for 'AND' and 'should' for 'OR'
                if (currentOperator === 'AND') {
                    shouldClauses.push({ bool: { must: wildcardQuery } });
                } else {
                    shouldClauses.push(wildcardQuery);
                }
            }
        });

        const requestBody = {
            query: {
                bool: {
                    should: shouldClauses
                }
            }
        };

        const url = `http://localhost:9200/university/_search`;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        })
            .then(response => response.json())
            .then(data => {
                displaySearchResults(data.hits.hits);
            })
            .catch(error => {
                console.error('Error fetching data from Elasticsearch:', error);
            });
    }

        function displaySearchResults(results) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';

            if (results.length === 0) {
                const noResultsCard = document.createElement('div');
                noResultsCard.classList.add('result-box');
                noResultsCard.innerHTML = `<p>No Results Found</p>`;
                searchResults.appendChild(noResultsCard);
            } else {
                results.forEach(result => {
                    const resultElement = document.createElement('div');
                    resultElement.classList.add('result-box');
                    resultElement.innerHTML = `<h3>${result._source.Name}</h3><p>${result._source.Description}</p>`;

                    if (result._source.Website) {
                        resultElement.innerHTML += `<a href="${result._source.Website}" target="_blank">Visit Website</a>`;
                    }

                    searchResults.appendChild(resultElement);
                });
            }
        }
    </script>
</body>

</html>
